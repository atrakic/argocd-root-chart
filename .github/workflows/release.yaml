name: Release Charts

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  release:
    permissions:
      contents: write
      packages: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Package Helm Chart
        run: |
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          CHART_NAME=$(grep '^name:' Chart.yaml | awk '{print $2}')
          
          echo "Packaging chart ${CHART_NAME} version ${CHART_VERSION}"
          helm package .
          
          echo "CHART_VERSION=${CHART_VERSION}" >> $GITHUB_ENV
          echo "CHART_NAME=${CHART_NAME}" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.event_name != 'pull_request'
        with:
          tag_name: v${{ env.CHART_VERSION }}
          name: Release ${{ env.CHART_VERSION }}
          body: |
            Release of ${{ env.CHART_NAME }} version ${{ env.CHART_VERSION }}
            
            ## Installation
            
            ### From GitHub Container Registry (OCI)
            ```bash
            helm install ${{ env.CHART_NAME }} oci://ghcr.io/${{ github.repository_owner }}/${{ env.CHART_NAME }} --version ${{ env.CHART_VERSION }}
            ```
            
            ### From GitHub Pages (Helm Repository)
            ```bash
            helm repo add ${{ github.repository_owner }} https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
            helm repo update
            helm install ${{ env.CHART_NAME }} ${{ github.repository_owner }}/${{ env.CHART_NAME }} --version ${{ env.CHART_VERSION }}
            ```
          files: ${{ env.CHART_NAME }}-${{ env.CHART_VERSION }}.tgz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Pages
        run: |
          # Store current branch
          CURRENT_BRANCH="${{ github.ref_name }}"
          
          # Fetch gh-pages branch or create orphan branch
          if git ls-remote --heads origin gh-pages | grep gh-pages; then
            git fetch origin gh-pages:gh-pages
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi
          
          # Copy the packaged chart from main branch
          git checkout ${CURRENT_BRANCH} -- ${CHART_NAME}-${CHART_VERSION}.tgz
          
          # Generate or update the index
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          
          # Commit and push
          git add ${CHART_NAME}-${CHART_VERSION}.tgz index.yaml
          git commit -m "Release ${CHART_NAME} ${CHART_VERSION}" || echo "No changes to commit"
          git push origin gh-pages
          
          # Return to original branch
          git checkout ${CURRENT_BRANCH}

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            helm registry login ghcr.io \
            -u ${{ github.actor }} --password-stdin

      - name: Push to GHCR
        run: |
          echo "Pushing ${CHART_NAME}-${CHART_VERSION}.tgz to ghcr.io"
          helm push ${CHART_NAME}-${CHART_VERSION}.tgz \
            oci://ghcr.io/${{ github.repository_owner }}

          OCI_PATH="ghcr.io/${{ github.repository_owner }}"
          echo "Chart pushed to ${OCI_PATH}/${CHART_NAME}:${CHART_VERSION}"

# Example release pipeline trigger:
#
# TAG="v0.0.1"
# git tag "$TAG" -m "Release version: $TAG"
# git push origin --tags
